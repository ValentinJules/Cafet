{% extends "base.html" %}

{% block title %}Liste des dettes - Caf√®t{% endblock %}
{% block header %}Liste des dettes{% endblock %}
{% block subtitle %}{% endblock %}

{% block content %}
<div class="form-container">
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    <div class="table-container">
        <table class="dettes-table" id="tableDettes">
            <thead>
                <tr>
                    <th class="sortable" data-sort="nom">
                        Nom <span class="sort-indicator">‚Üï</span>
                    </th>
                    <th class="sortable" data-sort="prenom">
                        Pr√©nom <span class="sort-indicator">‚Üï</span>
                    </th>
                    <th class="sortable" data-sort="statut">
                        Statut <span class="sort-indicator">‚Üï</span>
                    </th>
                    <th class="sortable" data-sort="dette">
                        Dette (‚Ç¨) <span class="sort-indicator">‚Üì</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for infos in personnes %}
                <tr>
                    <td data-nom="{{ infos['nom']|lower }}">{{ infos['nom'] }}</td>
                    <td data-prenom="{{ infos['prenom']|lower }}">{{ infos['prenom'] }}</td>
                    <td data-statut="{{ infos['statut']|lower }}">
                        <span class="statut-badge statut-{{ infos['statut'] }}">
                            {{ infos['statut'] }}
                        </span>
                    </td>
                    <td class="{{ 'dette-negatif' if infos['dette'] <= 0 else 'dette-positif' }}" data-dette="{{ infos['dette'] }}">
                        {{ '%.2f'|format(infos['dette']) }} ‚Ç¨
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" style="text-align: right; font-weight: bold;">Total des dettes :</td>
                    <td class="dette-total" id="totalDettes">
                        {{ '%0.2f'|format(personnes|sum(attribute='dette')) }} ‚Ç¨
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div style="margin-top: 30px; text-align: center;">
        <a href="{{ url_for('exporter_pdf') }}" class="button" style="display: inline-block; width: auto; padding: 12px 30px;">
            <span class="button-icon">üìÑ</span>G√©n√©rer le PDF
        </a>
    </div>
    
    <a href="{{ url_for('index') }}" class="back-link">‚Üê Retour √† l'accueil</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('tableDettes');
    const sortableHeaders = document.querySelectorAll('.sortable');
    let currentSort = { column: 'dette', direction: -1 }; // Par d√©faut tri√© par dette d√©croissante

    // Initialiser les indicateurs
    updateSortIndicators();

    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            
            // Si on clique sur la m√™me colonne, inverser la direction
            if (currentSort.column === column) {
                currentSort.direction *= -1;
            } else {
                // Sinon, trier par cette colonne en ordre croissant par d√©faut
                currentSort.column = column;
                currentSort.direction = 1;
            }
            
            // Trier le tableau
            sortTable(column, currentSort.direction);
            
            // Mettre √† jour les indicateurs visuels
            updateSortIndicators();
        });
    });
    
    function sortTable(column, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            let valueA, valueB;
            
            switch(column) {
                case 'nom':
                    valueA = a.querySelector('td[data-nom]').getAttribute('data-nom');
                    valueB = b.querySelector('td[data-nom]').getAttribute('data-nom');
                    break;
                case 'prenom':
                    valueA = a.querySelector('td[data-prenom]').getAttribute('data-prenom');
                    valueB = b.querySelector('td[data-prenom]').getAttribute('data-prenom');
                    break;
                case 'statut':
                    valueA = a.querySelector('td[data-statut]').getAttribute('data-statut');
                    valueB = b.querySelector('td[data-statut]').getAttribute('data-statut');
                    break;
                case 'dette':
                    valueA = parseFloat(a.querySelector('td[data-dette]').getAttribute('data-dette'));
                    valueB = parseFloat(b.querySelector('td[data-dette]').getAttribute('data-dette'));
                    break;
            }
            
            // Comparaison selon le type de donn√©es
            if (column === 'dette') {
                return (valueA - valueB) * direction;
            } else {
                if (valueA < valueB) return -1 * direction;
                if (valueA > valueB) return 1 * direction;
                return 0;
            }
        });
        
        // R√©ins√©rer les lignes tri√©es
        rows.forEach(row => tbody.appendChild(row));
    }
    
    function updateSortIndicators() {
        // R√©initialiser tous les indicateurs
        sortableHeaders.forEach(header => {
            const indicator = header.querySelector('.sort-indicator');
            indicator.textContent = '‚Üï';
            indicator.style.opacity = '0.5';
        });
        
        // Mettre √† jour l'indicateur de la colonne active
        const activeHeader = document.querySelector(`.sortable[data-sort="${currentSort.column}"]`);
        if (activeHeader) {
            const activeIndicator = activeHeader.querySelector('.sort-indicator');
            activeIndicator.textContent = currentSort.direction === 1 ? '‚Üë' : '‚Üì';
            activeIndicator.style.opacity = '1';
        }
    }
    
    // Trier initialement par dette d√©croissante
    sortTable('dette', -1);
});
</script>
{% endblock %}